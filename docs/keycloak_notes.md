---

## What Keycloak Is
- Authorization Server
- OpenID Connect Provider
- OAuth 2.1 token issuer
- Identity store

Rule:
- Keycloak **issues tokens**
- Your APIs **validate tokens**

---

## :contentReference[oaicite:0]{index=0} Mental Model
Realm → Clients → Users → Tokens → APIs

---

## Realm
- Top-level security boundary
- Own users, clients, roles, keys
- Isolated from other realms

Rules:
- Tokens are valid **only within a realm**
- No cross-realm trust by default

---

## Client
Represents an application.

Types:
- **Public** → SPA, mobile
- **Confidential** → backend, BFF

Key config:
- `client_id`
- Redirect URIs
- Access type
- PKCE (required for public)

Rules:
- Client ≠ user
- Client identifies the app

---

## Users
- Stored per realm
- Authenticate via:
  - Password
  - External IdP
- Assigned roles and groups

Rule:
- Users authenticate
- Clients authorize

---

## Roles
- **Realm roles** → global permissions
- **Client roles** → app-specific permissions

Where used:
- Access token
- ID token (if mapped)

Rule:
- APIs authorize based on roles, not usernames

---

## Groups
- Role aggregation
- Organizational structure
- Assigned to users

Rule:
- Groups simplify management
- Tokens contain **roles**, not groups

---

## Scopes (Keycloak vs OAuth)
Two meanings:

### OAuth scopes
- `openid`
- `profile`
- `email`

### Client Scopes (Keycloak)
- Control token contents
- Attach claims, roles
- Default or optional

Rule:
- Client scopes shape tokens
- OAuth scopes request permissions

---

## Tokens
- **Access Token** → API authorization
- **ID Token** → authentication
- **Refresh Token** → renew access

Defaults:
- JWT
- Signed by realm key

Rule:
- APIs accept access tokens only
- Clients validate ID tokens

---

## Token Validation (API side)
Validate:
- Signature (JWKS)
- `iss` (realm URL)
- `aud` (API / client)
- `exp`

Rule:
- Do not introspect per request unless required

---

## PKCE in Keycloak
- Mandatory for public clients
- Configured per client
- Enforced at `/token`

Rule:
- PKCE replaces client secret for SPAs

---

## State and Nonce
- Generated by client
- Passed through Keycloak
- Echoed back

Rules:
- Client must validate both
- Keycloak does not validate them for you

---

## Redirect Flow (Keycloak View)
1. `/authorize`
2. Login UI
3. Consent (optional)
4. Redirect with `code`
5. `/token` (PKCE check)
6. Tokens issued

Rule:
- All critical security checks happen at `/token`

---

## Keys and Rotation
- Realm owns signing keys
- Public keys exposed via JWKS
- Rotation supported

Rule:
- Clients and APIs must support key rotation

---

## Common Misconfigurations
- Wildcard redirect URIs
- Long-lived access tokens
- Missing roles in tokens
- Using ID token for APIs
- No PKCE for public clients

---

## One-Line Memory Hooks
- Realm = security universe
- Client = application
- User = human
- Role = permission
- Token = proof
- PKCE = safety belt
